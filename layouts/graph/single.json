{{- $noop := partialCached "functions/linkable-pages" . -}}
{{- $pages := dict -}}
{{- $graph := dict -}}

{{- range site.RegularPages -}}
  {{- $noop := .Content -}}
  {{- $pages = merge $pages (dict .RelPermalink (dict
    "permalink" .RelPermalink
    "title" (.Title | plainify | htmlEscape)
    "section" .Section
  )) -}}
  
  {{- $incoming := slice -}}
  {{- $outgoing := slice -}}
  
  {{- with .Scratch.Get "incoming" -}}
    {{- range . -}}
      {{- $incoming = $incoming | append .RelPermalink -}}
    {{- end -}}
  {{- end -}}
  
  {{- with .Scratch.Get "outgoing" -}}
    {{- range . -}}
      {{- $outgoing = $outgoing | append .RelPermalink -}}
    {{- end -}}
  {{- end -}}
  
  {{- $graph = merge $graph (dict .RelPermalink (dict
    "in" $incoming
    "out" $outgoing
  )) -}}
{{- end -}}

{{- $result := dict "pages" $pages "graph" $graph -}}
{{ $result | jsonify }}
